# ãªãœå‹•ãã®ã‹ï¼Ÿ (Why-it-Works) â€” misskey-antennaTL

> **ç›®çš„**  
> *misskey-antennaTL* ã®å‹•ä½œåŸç†ã‚’â€œä¸€æ°—é€šè²«â€ã§æŠŠæ¡ã™ã‚‹ã€‚  
> æ¦‚è¦ã‚’ **TL;DR â†’ Mermaid å…¨ä½“å›³** ã§é€Ÿèª­ã—ã€ä»¥ä¸‹ã« **è©³ç´°è§£èª¬** ã¨ **Deep-Dive æŠ€è¡“ãƒ¡ãƒ¢** ã‚’ç¶šã‘ã¾ã™ã€‚  
> v1/v2/v3 ã§è§¦ã‚ŒãŸæŠ€è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ **ã™ã¹ã¦æ®‹ã—**ã€é‡è¤‡ã¯çµ±åˆã—ã¾ã—ãŸã€‚

---

## âœ¨ TL;DR

| è³ªå• | 5 ç§’ã§ç­”ãˆ |
|------|-----------|
| **ã©ã“ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒæ¥ã‚‹ï¼Ÿ** | Misskey API (antennas/notes + notes/conversation) |
| **èª°ãŒå‘¼ã¶ï¼Ÿ** | Edge Runtime ã® API Route (`/api/mentionContext`, `/api/contextTL`) |
| **å‹å®‰å…¨ã¯ï¼Ÿ** | Zod ã§å¤–éƒ¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ¤œè¨¼ |
| **UI æ›´æ–°ã¯ï¼Ÿ** | React + SWR ãŒ 30 ç§’ã”ã¨è‡ªå‹•å†æ¤œè¨¼ |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã¯ï¼Ÿ** | Vercel CDN 60 ç§’ + LRUCache(emoji) |
| **ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼Ÿ** | `isEmojiCacheReady` ãŒæ•´ã†ã¾ã§æç”»ã‚’é…å»¶ |

---

## ğŸ—ºï¸ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```mermaid
graph TD
  A["ãƒ–ãƒ©ã‚¦ã‚¶ (React/SWR)"] -->|GET /api/mentionContext| B["Edge API (route.ts)"]
  B -->|POST /api/antennas/notes ãªã©| C["Misskey API"]
  B -->|Zodå‹æ¤œè¨¼ & JSON| A
  B -.->|"CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ (60s)"| A
````

* **SWR** ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨å†æ¤œè¨¼ã‚’åˆ¶å¾¡ã€‚
* **Edge (Node ã§ã¯ãªã Edge Runtime)** ãŒ Misskey ã«ä»£ç†ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Zod ã§æ¤œè¨¼ â†’ CDN ã¨é€£æºã€‚
* çµµæ–‡å­—ç”»åƒã¯ **LRUCache** ã«ä¿ç®¡ã—ã€é »å‡ºçµµæ–‡å­—ã‚’åˆ‡ã‚‰ã•ãªã„ã€‚

---

## 1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã®å½¹å‰²

| å±¤           | ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹                                                                     | ä¸»ãªä»•äº‹                         | æŠ€è¡“                            |
| ----------- | ------------------------------------------------------------------------- | ---------------------------- | ----------------------------- |
| **ãƒ•ãƒ­ãƒ³ãƒˆ**    | `src/app/page.tsx`<br>`src/components/NoteCard.tsx`                       | SWR ã§ãƒ‡ãƒ¼ã‚¿å–å¾—â†’UIæç”»              | React (App Router) / Tailwind |
| **API ãƒ«ãƒ¼ãƒˆ** | `src/app/api/mentionContext/route.ts`<br>`src/app/api/contextTL/route.ts` | Misskey API ã¸ POST â†’ çµæœæ•´å½¢ãƒ»æ¤œè¨¼ | Next.js Edge Runtime / Zod    |
| **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**   | `src/lib/misskey.ts`                                                      | `misskeyFetch` å…±é€šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ      | fetch / ç’°å¢ƒå¤‰æ•°                  |
| **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£** | `src/lib/emoji.ts`                                                        | çµµæ–‡å­—ã‚­ãƒ£ãƒƒã‚·ãƒ¥ & ç½®æ›                | LRUCache / DOMPurify          |
| **å¤–éƒ¨**      | Misskey ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹                                                            | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹                       | Misskey API                   |

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°

### 2-1. ã‚¢ãƒ³ãƒ†ãƒŠ TL å–å¾—

1. HomePage ãƒã‚¦ãƒ³ãƒˆ â†’ `useSWR('/api/mentionContext')`
2. Edge ãƒ«ãƒ¼ãƒˆ

   1. `antennas/notes` å–å¾—
   2. å„ãƒãƒ¼ãƒˆã«å¯¾ã— `notes/conversation` ã‚’ **p-map** ä¸¦åˆ— (åŒæ™‚ 5 æœ¬)
3. å–å¾—çµæœã‚’ `ThreadSchema[]` ã§ **Zod.parse**
4. JSON + `Cache-Control: s-maxage=60, stale-while-revalidate` ã§è¿”é€
5. SWR ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’ UI å†æç”»

### 2-2. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ TL

*Note é¸æŠæ™‚ã®ã¿*

1. `useSWR('/api/contextTL?noteId=...')`
2. ãƒ«ãƒ¼ãƒˆãŒ `notes/show` + `notes/timeline` (å‰å¾Œ 2 æœ¬) ã‚’ä¸¦åˆ—å–å¾—
3. å¤±æ•—æ™‚ã¯ 500 â†’ fetcher ãŒ throw â†’ SWR `error` â†’ `toast.error`

---

## 3. ãªãœãã®æŠ€è¡“ï¼Ÿï¼ˆé¸æŠç†ç”±ã®æ¯”è¼ƒè¡¨ï¼‰

| æŠ€è¡“                     | å€™è£œ vs æ¡ç”¨       | æ¡ç”¨ç†ç”±                                              |
| ---------------------- | -------------- | ------------------------------------------------- |
| **Next.js App Router** | Pages Router   | Nested Layout / Server Component / Edge API ã‚’ä¸€è²«ç®¡ç† |
| **Edge Runtime**       | Node Functions | åœ°ç†çš„ã«è¿‘ã„ï¼‹CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚·ãƒ¼ãƒ ãƒ¬ã‚¹                             |
| **SWR**                | React Query    | è»½é‡ãƒ»å®£è¨€çš„ãƒ»å†æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãŒ 1 è¡Œ                               |
| **Zod**                | io-ts / yup    | å‹ã¨å®Ÿè¡Œæ™‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ 1 ã‚½ãƒ¼ã‚¹ç®¡ç†                             |
| **LRUCache**           | Map + TTL      | é »å‡ºçµµæ–‡å­—ã‚’è‡ªå‹•ã§æ®‹ã—ã¤ã¤ä¸Šé™åˆ¶å¾¡                                 |

---

## 4. Deep-Dive â‘  å‹å®‰å…¨ & ã‚¨ãƒ©ãƒ¼ä¼æ¬

```plaintext
Misskeyãƒ¬ã‚¹ãƒãƒ³ã‚¹
   â†“ Zod.parse()
      â”œâ”€ OK â†’ JSON 200
      â””â”€ NG â†’ ZodError
               â†“ catch â†’ JSON 500
                     â†“ fetcher â†’ throw Error
                            â†“ SWR error â†’ toast.error
```

* ãƒã‚¤ãƒ³ãƒˆã¯ã€Œ**å£Šã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒ UI ã«å±Šãå‰ã« 2 å›å¼¾ã**ã€ã€‚
* ä¾‹å¤–ã¯è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ãã§ãƒ­ã‚°ï¼ˆEdgeï¼‰ã¨ãƒ¦ãƒ¼ã‚¶é€šçŸ¥ï¼ˆtoastï¼‰ã®ä¸¡æ–¹ã¸ã€‚

---

## 5. Deep-Dive â‘¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

| ãƒ¬ã‚¤ãƒ¤                  | TTL                      | ç›®çš„              |
| -------------------- | ------------------------ | --------------- |
| **Vercel CDN**       | 60 s (`s-maxage`)        | Misskey å‘¼ã³å‡ºã—ã‚’æŠ‘åˆ¶ |
| **SWR ãƒ­ãƒ¼ã‚«ãƒ«**         | 30 s (`refreshInterval`) | ãƒ–ãƒ©ã‚¦ã‚¶é–“é€šä¿¡ã‚’ 0 ã«    |
| **LRUCache (emoji)** | Max 2000 ã‚¨ãƒ³ãƒˆãƒª            | é »å‡ºçµµæ–‡å­—ã‚’å³è¡¨ç¤º       |

* ãƒ¡ãƒ¢ãƒªâ†’CDNâ†’Misskey ã®å„ªå…ˆé †ã€‚
* çµµæ–‡å­—ã¯ 977 å€‹ â†’ LRU `max:2000` ã§å…¨ä¿æŒã—ã¤ã¤ä½™è£•æ ã€‚

---

## 6. Deep-Dive â‘¢ çµµæ–‡å­— & ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

1. ãƒšãƒ¼ã‚¸åˆå›ãƒ­ãƒ¼ãƒ‰

   * SSRï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ `:penguin:` ã®ã¾ã¾
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ `useEffect`

   * `fetchAndCacheEmojis` â†’ LRUCache ã«ãƒ­ãƒ¼ãƒ‰
   * `setIsEmojiCacheReady(true)`
3. `isLoading = ... || !isEmojiCacheReady` ãŒ false ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ `NoteCard` æç”»
4. `dangerouslySetInnerHTML` ã§ `<img src=".../penguin.png">` ã«ç½®æ›

> **ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ**ï¼šSSR ã¨ CSR ã® DOM å·®åˆ†ãŒç„¡ã„çŠ¶æ…‹ã§åˆå›æç”»ã€‚

---

## 7. ã‚ˆãã‚ã‚‹è³ªå• (FAQ)

| Q                              | A                                        |
| ------------------------------ | ---------------------------------------- |
| Edge Runtime ã§ Node API ã¯ï¼Ÿ     | Buffer/crypto ä»¥å¤–ã¯ä¸å¯ã€‚fetch ãƒ™ãƒ¼ã‚¹ãªã‚‰å•é¡Œãªã—ã€‚     |
| `dangerouslySetInnerHTML` ã¯å®‰å…¨ï¼Ÿ | DOMPurify æ¸ˆã¿ & Misskey ç”±æ¥ã ã‘ã‚’è¨±å®¹ã€‚          |
| ãƒãƒ¼ãƒªãƒ³ã‚° 30 s ã¯å¤šããªã„ï¼Ÿ              | CDN ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¾¼ã¿ã§ Misskey ç›´æ’ƒã¯æœ€å°ã€‚å¿…è¦ãªã‚‰ç’°å¢ƒå¤‰æ•°ã§èª¿æ•´å¯ã€‚ |

---

## 8. é–‹ç™º Tips / Quick Links

* **ä¸»è¦APIãƒ«ãƒ¼ãƒˆ**: [`src/app/api/mentionContext/route.ts`](../src/app/api/mentionContext/route.ts)
* **SWRå…±é€šãƒ•ã‚§ãƒƒãƒãƒ£**: [`src/lib/fetcher.ts`](../src/lib/fetcher.ts)
* **Zod ã‚¹ã‚­ãƒ¼ãƒ**: [`src/lib/misskey.ts`](../src/lib/misskey.ts)
* **çµµæ–‡å­—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£**: [`src/lib/emoji.ts`](../src/lib/emoji.ts)
* **Tailwind ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰**: `npm run dev` â†’ `http://localhost:3000/play`

---

## 9. ã¾ã¨ã‚

> **ãƒ–ãƒ©ã‚¦ã‚¶**ãŒã€Œ30 ç§’ã”ã¨ã€ã«çŠ¶æ³ã‚’å°‹ã­
> **Edge**ãŒã€Œå¤–éƒ¨ APIï¼‹å‹æ¤œè¨¼ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã§ä»²ä»‹ã—
> **Misskey**ãŒã€Œç”Ÿãƒ‡ãƒ¼ã‚¿ã€ã‚’è¿”ã™ã€‚
> ãã® 3 è€…ãŒ **å£Šã‚ŒãŸã¨ãã®é€ƒã’é“**ã‚’å…¨éƒ¨æŒã£ã¦ã„ã‚‹ã‹ã‚‰ã€
> ãƒ¦ãƒ¼ã‚¶ã¯ *Misskey ã‚’ãã®ã¾ã¾è¦‹ã¦ã„ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã‚‰ã‚Œã‚‹*â”€â”€
> ã“ã‚ŒãŒ **ã€Œãªãœå‹•ãã®ã‹ï¼Ÿã€ã®çœŸã®ç­”ãˆ** ã§ã™ã€‚
