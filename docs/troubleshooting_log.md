# トラブルシューティングログ

## 2025-07-11: 絵文字が表示されない問題の解決

### 発生した問題

1.  **モジュール不足:** アプリケーション起動時に `lru-cache` モジュールが見つからないというエラーが発生した。
2.  **ハイドレーションエラー:** サーバーサイドレンダリング(SSR)とクライアントサイドでのレンダリング結果が一致せず、Reactのハイドレーションエラーがコンソールに表示された。
3.  **絵文字の非表示:** 上記エラーを解決した後も、ノート本文中の絵文字ショートコード（例: `:blobadeliae_hmm:`）が画像に置換されず、文字列のまま表示された。

### 調査と解決の過程

1.  **モジュール不足の解決:**
    - `npm install lru-cache` を実行し、不足している依存関係をプロジェクトに追加した。

2.  **ハイドレーションエラーの調査と解決:**
    - **原因特定:** `useEffect`内で非同期に絵文字キャッシュを読み込んでいる間に、ノート表示コンポーネントが描画されてしまうことが原因だと判明。SSR時点ではキャッシュが空のため、サーバーとクライアントでHTMLの構造が異なってしまっていた。
    - **対策:** 絵文字キャッシュの準備が完了したかを管理する状態 (`isEmojiCacheReady`) を導入。キャッシュが準備できるまでローディング画面を表示し、完了後にノートを描画するように変更してハイドレーションエラーを解消した。

3.  **絵文字非表示問題の調査と解決:**
    - **原因の切り分け:**
        - 当初、APIエンドポイント (`/api/emojis`) の間違いや、リクエストメソッド (`GET` vs `POST`) の誤りを疑い修正したが、問題は解決しなかった。
        - `console.log` を追加してデバッグした結果、APIから絵文字データは正しく取得できているものの、キャッシュからデータを取り出す時点で `Not found in cache` となっていることが判明した。
    - **根本原因の特定:** `lru-cache` のインスタンス作成時に設定したキャッシュの最大サイズ (`max: 500`) が、サーバーから取得した絵文字の総数 (977個) よりも小さかった。これにより、キャッシュの先頭に追加された絵文字が、後続の絵文字で押し出されて削除されていたことが根本的な原因だと特定した。
    - **最終的な解決策:** `lru-cache` の最大サイズを `2000` に増やすことで、すべての絵文字がキャッシュに保持されるようにし、問題を完全に解決した。
